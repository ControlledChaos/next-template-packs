window.wp=window.wp||{},window.bp=window.bp||{},function(e,t){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.GroupInvites={start:function(){this.scope=null,this.views=new Backbone.Collection,this.navItems=new Backbone.Collection,this.users=new bp.Collections.Users,this.invites=this.users.clone(),this.setupNav(),this.setupLoops(),this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.users.on("change:selected",this.addInvite,this),this.invites.on("change:selected",this.manageInvite,this),this.invites.on("add",this.invitesNav,this),this.invites.on("reset",this.hideInviteNav,this)},setupNav:function(){var e;this.nav=new bp.Views.invitesNav({collection:this.navItems}),_.each(BP_Nouveau.group_invites.nav,function(t,i){_.isObject(t)&&(e=0,0===i&&(this.scope=t.id,e=1),this.navItems.add({id:t.id,name:t.caption,href:"#",active:e,hide:_.isUndefined(t.hide)?0:t.hide}))},this),this.nav.inject(".bp-invites-nav"),this.nav.on("bp-invites:confirm",this.loadConfirmView,this),this.nav.on("bp-invites:loops",this.setupLoops,this)},setupLoops:function(e){var t;e=e||this.scope,this.clearViews(),e!==this.scope&&this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.scope=e,t=new bp.Views.inviteUsers({collection:this.users,scope:e}),this.views.add({id:"users",view:t}),t.inject(".bp-invites-content"),this.displayFilters(this.users)},displayFilters:function(e){var t;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",scope:this.scope}),t=new bp.Views.inviteFilters({model:this.filters,users:e}),this.views.add({id:"filters",view:t}),t.inject(".bp-invites-filters")},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}))},displayFeedback:function(e,t){var i;this.removeFeedback(),e&&(i=new bp.Views.Feedback({value:e,type:t||"info"}),this.views.add({id:"feedback",view:i}),i.inject(".bp-invites-feedback"))},addInvite:function(e){if(!0===e.get("selected"))this.invites.add(e);else{var t=this.invites.get(e.get("id"));!0===t.get("selected")&&this.invites.remove(t)}},manageInvite:function(e){var t=this.users.get(e.get("id"));t&&t.set("selected",!1),this.invites.remove(e),this.invites.length||this.invites.reset()},invitesNav:function(){this.navItems.get("invites").set({active:0,hide:0})},hideInviteNav:function(){this.navItems.get("invites").set({active:0,hide:1})},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},loadConfirmView:function(){this.clearViews(),this.displayFeedback(BP_Nouveau.group_invites.invites_form,"help");var e=new bp.Views.invitesEditor({collection:this.invites});this.views.add({id:"invites",view:e}),e.inject(".bp-invites-content")}},bp.Models.User=Backbone.Model.extend({defaults:{id:0,avatar:"",name:"",selected:!1}}),bp.Collections.Users=Backbone.Collection.extend({model:bp.Models.User,initialize:function(){this.options={page:1,total_page:0,group_id:BP_Nouveau.group_invites.group_id}},sync:function(e,t,i){return i=i||{},i.context=this,i.data=i.data||{},i.data.nonce=BP_Nouveau.nonces.groups,this.options.group_id&&(i.data.group_id=this.options.group_id),"read"===e?(i.data=_.extend(i.data,{action:"groups_get_group_potential_invites"}),bp.ajax.send(i)):"create"===e?(i.data=_.extend(i.data,{action:"groups_send_group_invites",_wpnonce:BP_Nouveau.group_invites.nonces.send_invites}),t&&(i.data.users=t),bp.ajax.send(i)):"delete"===e?(i.data=_.extend(i.data,{action:"groups_delete_group_invite",_wpnonce:BP_Nouveau.group_invites.nonces.uninvite}),t&&(i.data.user=t),bp.ajax.send(i)):void 0},parse:function(e){return _.isArray(e.users)||(e.users=[e.users]),_.each(e.users,function(t,i){_.isNull(t)||(e.users[i].id=t.id,e.users[i].avatar=t.avatar,e.users[i].name=t.name)}),_.isUndefined(e.meta)||(this.options.page=e.meta.page,this.options.total_page=e.meta.total_page),e.users}}),bp.Nouveau.GroupInvites.View=bp.Backbone.View.extend({inject:function(e){this.render(),t(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.GroupInvites.View.extend({tagName:"div",className:"bp-feedback",initialize:function(){this.value=this.options.value,this.options.type&&(this.el.className+=" "+this.options.type)},render:function(){return this.$el.html(this.value),this}}),bp.Views.invitesNav=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",events:{"click .bp-invites-nav-item":"toggleView"},initialize:function(){this.collection.on("add",this.outputNav,this),this.collection.on("change:hide",this.showHideNavItem,this)},outputNav:function(e){1!==e.get("hide")&&this.views.add(new bp.Views.invitesNavItem({model:e}))},showHideNavItem:function(e){var t=null;_.each(this.views._views[""],function(i){1===i.model.get("hide")&&i.remove(),e.get("id")===i.model.get("id")&&(t=!0)}),_.isBoolean(t)||(e.set("invites_count",bp.Nouveau.GroupInvites.invites.length),this.outputNav(e))},toggleView:function(e){var i=t(e.target);e.preventDefault(),i.data("nav")||"SPAN"!==e.target.tagName||(i=t(e.target).parent());var s=i.data("nav");_.each(this.collection.models,function(e){e.id===s?(e.set("active",1),"invites"===e.id?this.trigger("bp-invites:confirm"):this.trigger("bp-invites:loops",e.id)):1!==e.get("hide")&&e.set("active",0)},this)}}),bp.Views.invitesNavItem=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-nav"),initialize:function(){1===this.model.get("active")&&(this.el.className+=" current"),"invites"===this.model.get("id")&&(this.el.className+=" dynamic"),"invited"===this.model.get("id")&&(this.el.className+=" pending"),this.model.on("change:active",this.toggleClass,this),this.on("ready",this.updateCount,this),bp.Nouveau.GroupInvites.invites.on("add",this.updateCount,this),bp.Nouveau.GroupInvites.invites.on("remove",this.updateCount,this)},updateCount:function(e,i){if("invites"===this.model.get("id")){var s=_.isUndefined(i)?this.model.get("invites_count"):i.models.length;t(this.el).find("span").length?t(this.el).find("span").html(s):t(this.el).find("a").append(t("<span></span>").html(s))}},toggleClass:function(e){0===e.get("active")?t(this.el).removeClass("current"):t(this.el).addClass("current")}}),bp.Views.Pagination=bp.Nouveau.GroupInvites.View.extend({tagName:"li",className:"last",template:bp.template("bp-invites-paginate")}),bp.Views.inviteFilters=bp.Nouveau.GroupInvites.View.extend({tagName:"div",template:bp.template("bp-invites-filters"),events:{"focus #group_invites_search":"displaySrcBtn","blur #group_invites_search":"hideSrcBtn","search #group_invites_search":"resetSearchTerms","submit #group_invites_search_form":"setSearchTerms","click #bp-invites-next-page":"nextPage","click #bp-invites-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterUsers,this),this.options.users.on("sync",this.addPaginatation,this)},addPaginatation:function(e){_.each(this.views._views[""],function(e){e.remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterUsers:function(){bp.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.options.users.reset(),this.options.users.fetch({data:_.pick(this.model.attributes,["scope","search_terms","page"]),success:this.usersFiltered,error:this.usersFilterError})},usersFiltered:function(){bp.Nouveau.GroupInvites.removeFeedback()},usersFilterError:function(e,t){bp.Nouveau.GroupInvites.displayFeedback(t.feedback,"error")},displaySrcBtn:function(e){e.preventDefault(),t(e.target).closest("form").find("[type=submit]").addClass("bp-show")},hideSrcBtn:function(e){e.preventDefault(),t(e.target).val()||t(e.target).closest("form").find("[type=submit]").addClass("bp-hide").removeClass("bp-show")},resetSearchTerms:function(e){e.preventDefault(),t(e.target).val()?t(e.target).closest("form").find("[type=submit]").addClass("bp-show"):t(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:t(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),bp.Views.inviteUsers=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",className:"item-list bp-list",id:"members-list",initialize:function(){this.requestUsers(),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addUser,this)},requestUsers:function(){this.collection.reset(),this.collection.fetch({data:_.pick(this.options,"scope"),success:this.usersFetched,error:this.usersFetchError})},usersFetched:function(e,t){bp.Nouveau.GroupInvites.displayFeedback(t.feedback,"help")},usersFetchError:function(e,t){var i=t.type||"help";bp.Nouveau.GroupInvites.displayFeedback(t.feedback,i)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})},addUser:function(e){this.views.add(new bp.Views.inviteUser({model:e}))}}),bp.Views.inviteUser=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-users"),events:{"click .group-add-remove-invite-button":"toggleUser","click .group-remove-invite-button":"removeInvite"},initialize:function(){bp.Nouveau.GroupInvites.invites.get(this.model.get("id"))&&(this.el.className="selected",this.model.set("selected",!0,{silent:!0}))},toggleUser:function(e){e.preventDefault(),!1===this.model.get("selected")?(this.model.set("selected",!0),t(this.el).addClass("selected")):(this.model.set("selected",!1),t(this.el).removeClass("selected"),bp.Nouveau.GroupInvites.invites.length||bp.Nouveau.GroupInvites.invites.reset())},removeInvite:function(e){e.preventDefault();var t=this.model.collection;t.length&&t.sync("delete",this.model.get("id"),{success:_.bind(this.inviteRemoved,this),error:_.bind(this.uninviteError,this)})},inviteRemoved:function(e){var t=this.model.collection;t.length&&(t.remove(this.model),this.remove(),bp.Nouveau.GroupInvites.removeFeedback(),!1===e.has_invites&&(bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:1})))},uninviteError:function(e){bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"error")}}),bp.Views.invitesEditor=bp.Nouveau.GroupInvites.View.extend({tagName:"div",id:"send-invites-editor",events:{"click #bp-invites-send":"sendInvites","click #bp-invites-reset":"clearForm"},initialize:function(){this.views.add(new bp.Views.selectedUsers({collection:this.collection})),this.views.add(new bp.Views.invitesForm),this.collection.on("reset",this.cleanViews,this)},sendInvites:function(e){e.preventDefault(),t(this.el).addClass("bp-hide"),this.collection.sync("create",_.pluck(this.collection.models,"id"),{success:_.bind(this.invitesSent,this),error:_.bind(this.invitesError,this),data:{message:t(this.el).find("textarea").val()}})},invitesSent:function(e){this.collection.reset(),bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),1!==bp.Nouveau.GroupInvites.navItems.get("invited").get("hide")||BP_Nouveau.group_invites.is_group_create||bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0})},invitesError:function(e){var i=e.type||"help";t(this.el).removeClass("bp-hide"),bp.Nouveau.GroupInvites.displayFeedback(e.feedback,i),_.isUndefined(e.users)||(1===bp.Nouveau.GroupInvites.navItems.get("invited").get("hide")&&e.users.length<this.collection.length&&bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0}),_.each(this.collection.models,function(t){-1===_.indexOf(e.users,t.get("id"))&&t.set("selected",!1)},this))},clearForm:function(e){e.preventDefault(),this.collection.reset()},cleanViews:function(){_.each(this.views._views[""],function(e){e.remove()}),bp.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.invites_form_reset,"help")}}),bp.Views.invitesForm=bp.Nouveau.GroupInvites.View.extend({tagName:"div",id:"bp-send-invites-form",template:bp.template("bp-invites-form")}),bp.Views.selectedUsers=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",initialize:function(){this.cleanContent(),_.each(this.collection.models,function(e){this.views.add(new bp.Views.selectedUser({model:e}))},this)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})}}),bp.Views.selectedUser=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-selection"),events:{click:"removeSelection"},initialize:function(){this.model.on("change:selected",this.removeView,this)},removeSelection:function(e){e.preventDefault(),this.model.set("selected",!1)},removeView:function(e){!1===e.get("selected")&&this.remove()}}),bp.Nouveau.GroupInvites.start())}(bp,jQuery);